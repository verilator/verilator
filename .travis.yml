# DESCRIPTION: Travis-CI config
#
# Copyright 2003-2020 by Wilson Snyder. This program is free software; you
# can redistribute it and/or modify it under the terms of either the GNU
# Lesser General Public License Version 3 or the Perl Artistic License
# Version 2.0.
# SPDX-License-Identifier: LGPL-3.0-only OR Artistic-2.0

version: ~> 1.0

language: cpp

cache:
  directories:
    - $HOME/.ccache

env:
  global:
    - VERILATOR_ROOT=$TRAVIS_BUILD_DIR

# The list and order of build stages
stages:
  - build # Build Verilator
  - test  # Run tests

# Dump info about the environment for debugging
before_install:
  # To dump the script that Travis itself is executing, add 'cat $0' here
  - cd "$TRAVIS_BUILD_DIR" # Skipping the git clone in later stages requires this
  - export CCACHE_MAXSIZE=$(ci/travis-ccache-size.bash) # Set here after the 'cd'
  - env | sort
  - ls -lA .
  - ls -lA bin
  - g++ -E -dM -c -x c++ /dev/null | sort
  - clang++ -E -dM -c -x c++ /dev/null | sort

# Install all dependencies
install:
  - ./ci/travis-install.bash

before_script:
  # ccache maintenance
  - ./ci/travis-ccache-maint.bash
  # Don't produce core dumps (esp. on FreeBSD)
  - ulimit -c 0
  # On Focal, set the SystemC installation location
  - |
    if [ "$TRAVIS_DIST" = "focal" ] && [ "$M32" != "1" ]; then
      export SYSTEMC_INCLUDE=/usr/include
      export SYSTEMC_LIBDIR=/usr/lib/x86_64-linux-gnu
    fi
  # Override compiler for M32
  - |
    if [ "$M32" = "1" ]; then
      export CC="$CC -m32"
      export CXX="$CXX -m32"
      unset M32 # verilated.mk actually references $(M32) so unset
    fi

before_cache:
  - ccache -s -z

# All jobs run the same script
script: ./ci/travis-script.bash

# Enumerate all the jobs
jobs:
  include:
    ############################################################################
    # Jobs in the 'build' stage
    ############################################################################
    # OS X build
    - {stage: build,                   os: osx, osx_image: xcode11.6, compiler: clang, workspaces: {create: {name: osx-xcode11.6, paths: .}}}
    ############################################################################
    # Jobs in the 'test' stage
    ############################################################################
    # OS X tests
    - {stage: test,                   os: osx, osx_image: xcode11.6, compiler: clang, workspaces: {use: osx-xcode11.6},  git: {clone: false}, env: TESTS=dist-vlt-0}
    - {stage: test,                   os: osx, osx_image: xcode11.6, compiler: clang, workspaces: {use: osx-xcode11.6},  git: {clone: false}, env: TESTS=dist-vlt-1}
    - {stage: test,                   os: osx, osx_image: xcode11.6, compiler: clang, workspaces: {use: osx-xcode11.6},  git: {clone: false}, env: TESTS=vltmt-0}
    - {stage: test,                   os: osx, osx_image: xcode11.6, compiler: clang, workspaces: {use: osx-xcode11.6},  git: {clone: false}, env: TESTS=vltmt-1}

notifications:
  email:
    if: repo = verilator/verilator
    recipients:
      - wsnyder@wsnyder.org
      - todd.strader@gmail.com
